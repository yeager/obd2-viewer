name: Build RPM

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-rpm:
    runs-on: ubuntu-latest
    container:
      image: fedora:latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install build dependencies
        run: |
          dnf update -y
          dnf install -y \
            rpm-build rpmdevtools \
            python3-devel python3-setuptools \
            desktop-file-utils gettext
      
      - name: Set up RPM build environment
        run: |
          rpmdev-setuptree
          
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION="0.1.0"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
      
      - name: Create RPM spec and build
        run: |
          cat > ~/rpmbuild/SPECS/obd2-viewer.spec << 'SPEC'
          Name:           obd2-viewer
          Version:        VERSION_PLACEHOLDER
          Release:        1
          Summary:        OBD2 diagnostic data viewer and logger
          
          License:        GPL-3.0-or-later
          URL:            https://github.com/yeager/obd2-viewer
          Source0:        %{name}-%{version}.tar.gz
          
          BuildArch:      noarch
          BuildRequires:  python3-devel python3-setuptools desktop-file-utils gettext
          Requires:       python3-gobject gtk4 libadwaita
          
          %description
          OBD2 Viewer is a GTK4/Libadwaita application for OBD2 diagnostic data.
          
          %prep
          %setup -q
          
          %build
          %py3_build
          
          %install
          %py3_install
          
          mkdir -p %{buildroot}%{_datadir}/applications
          desktop-file-install --dir=%{buildroot}%{_datadir}/applications data/se.danielnylander.obd2-viewer.desktop
          
          mkdir -p %{buildroot}%{_datadir}/icons/hicolor/scalable/apps
          cp data/icons/se.danielnylander.obd2-viewer.svg %{buildroot}%{_datadir}/icons/hicolor/scalable/apps/
          
          %files
          %license LICENSE
          %doc README.md
          %{python3_sitelib}/obd2_viewer/
          %{python3_sitelib}/obd2_viewer-*.egg-info/
          %{_bindir}/obd2-viewer
          %{_datadir}/applications/se.danielnylander.obd2-viewer.desktop
          %{_datadir}/icons/hicolor/scalable/apps/se.danielnylander.obd2-viewer.svg
          
          %changelog
          SPEC
          sed -i "s/VERSION_PLACEHOLDER/$VERSION/g" ~/rpmbuild/SPECS/obd2-viewer.spec
          echo "          * $(date '+%a %b %d %Y') Daniel Nylander <daniel@danielnylander.se> - $VERSION-1" >> ~/rpmbuild/SPECS/obd2-viewer.spec
          echo "          - New upstream release" >> ~/rpmbuild/SPECS/obd2-viewer.spec
          
          sed -i "s/__version__ = \".*\"/__version__ = \"$VERSION\"/" src/obd2_viewer/__init__.py
          
          tar czf ~/rpmbuild/SOURCES/obd2-viewer-$VERSION.tar.gz \
            --transform "s,^,obd2-viewer-$VERSION/," \
            --exclude='.git*' --exclude='*.pyc' --exclude='__pycache__' \
            *
          
          rpmbuild -ba ~/rpmbuild/SPECS/obd2-viewer.spec
      
      - name: Upload RPM artifacts
        uses: actions/upload-artifact@v3
        with:
          name: rpm-packages
          path: |
            ~/rpmbuild/RPMS/noarch/*.rpm
            ~/rpmbuild/SRPMS/*.rpm
